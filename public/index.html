<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="style.css">
<title>Device Simulator</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
    <div class="container">
      <div class="panel">
        <div class="panel-inner"></div>
      </div>
      <div class="controls">
        <h1>Washing Machine Simulator</h1>
        
        <label for="programSelector">Choose a program:</label>
        <select id="programSelector" onchange="updateDetails()">
          <option value="">--Select a Program--</option>
          <!-- Options will be populated here by JavaScript -->
        </select>
        
        <p>Temperature: <span id="temperatureDisplay">--</span></p>
        <p>Spin Speed: <span id="spinSpeedDisplay">--</span></p>
        
        <button id="startButton">Start</button>
      </div>
    </div>

    <script>
      let programs = [];
      // Fetch programs from the backend and populate the dropdown
      window.onload = async function() {
        try {
          console.log("Fetching programs...");
          const response = await axios.get('/energymanagement/simulator/program');
          console.log("Response received:", response.data);
          programs = response.data;
          const selector = document.getElementById('programSelector');
          
          programs.forEach(program => {
            const option = document.createElement('option');
            option.value = program.programId;
            option.textContent = program.programName;
            selector.appendChild(option);
          });
        } catch (error) {
          console.error('Error fetching programs:', error);
        }
      };
    
      // Update temperature and spin speed display when a program is selected
      function updateDetails() {
        const selectedProgramId = document.getElementById('programSelector').value;
        const selectedProgram = programs.find(program => program.programId.toString() === selectedProgramId);
        if (selectedProgram) {
          document.getElementById('temperatureDisplay').textContent = selectedProgram.temperature;
          document.getElementById('spinSpeedDisplay').textContent = selectedProgram.spinSpeed;
        } else {
          document.getElementById('temperatureDisplay').textContent = '--';
          document.getElementById('spinSpeedDisplay').textContent = '--';
        }
      }
        
      // Attach an event listener to the start button
      document.addEventListener('DOMContentLoaded', function () {
        const mqttClient = mqtt.connect('ws://test.mosquitto.org:8081'); // WebSocket URL

        mqttClient.on('connect', function () {
          console.log('Connected to MQTT broker');
        });

        document.getElementById('startButton').onclick = function () {
          const selectedProgramId = document.getElementById('programSelector').value;
          if (selectedProgramId) {
            const selectedProgram = programs.find(program => program.programId.toString() === selectedProgramId);
            
            if (!selectedProgram) {
              alert('Selected program data is not available.');
              return;
            }

            const postData = {
              programName: selectedProgram.programName,
              temperature: selectedProgram.temperature,
              spinSpeed: selectedProgram.spinSpeed,
              electricConsumption: selectedProgram.electricConsumption,
              waterConsumption: selectedProgram.waterConsumption,
              duration: selectedProgram.duration
            };

            mqttClient.publish('simulator/program', JSON.stringify(postData), function (err) {
              if (err) {
                console.error('Failed to publish message', err);
                alert('Failed to start calculation');
              } else {
                alert('Calculation started and session added!');
                console.log('Message published', postData);
              }
            });
          } else {
            alert('Please select a program.');
          }
        };
      });
    </script>
</body>
</html>
